name: Manual Build & Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          VERSION="v1.0.$(date +'%Y%m%d%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          draft: true

      # ---------- Debian ----------
      - name: Publish Debian
        run: |
          dotnet publish -c Release -r linux-x64 --self-contained true -o publish/debian
          cd publish && zip -r AxarDB-debian.zip debian

      - name: Upload Debian asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: publish/AxarDB-debian.zip

      # ---------- Windows ----------
      - name: Publish Windows
        run: |
          dotnet publish -c Release -r win-x64 --self-contained true -o publish/windows
          cd publish && zip -r AxarDB-windows.zip windows

      - name: Upload Windows asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: publish/AxarDB-windows.zip

      # ---------- macOS ----------
      - name: Publish macOS
        run: |
          dotnet publish -c Release -r osx-x64 --self-contained true -o publish/macos
          cd publish && zip -r AxarDB-macos.zip macos

      - name: Upload macOS asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: publish/AxarDB-macos.zip

      # ---------- Publish ----------
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          draft: false
