name: Manual Build & Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version (YYMMDD)
        run: |
          DATE_CODE=$(date +'%y%m%d')
          echo "TAG_VERSION=v1.0.$DATE_CODE" >> $GITHUB_ENV
          echo "FILE_VERSION=1.0.$DATE_CODE" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # Debian
      - name: Publish Debian
        run: |
          dotnet publish -c Release -r linux-x64 --self-contained true \
            -p:Version=1.0.0 \
            -p:FileVersion=${{ env.FILE_VERSION }} \
            -o publish/debian
          cd publish && zip -r AxarDB-debian.zip debian

      # Windows
      - name: Publish Windows
        run: |
          dotnet publish -c Release -r win-x64 --self-contained true \
            -p:Version=1.0.0 \
            -p:FileVersion=${{ env.FILE_VERSION }} \
            -o publish/windows
          cd publish && zip -r AxarDB-windows.zip windows

      # macOS
      - name: Publish macOS
        run: |
          dotnet publish -c Release -r osx-x64 --self-contained true \
            -p:Version=1.0.0 \
            -p:FileVersion=${{ env.FILE_VERSION }} \
            -o publish/macos
          cd publish && zip -r AxarDB-macos.zip macos

      # âœ… SINGLE release step (CRITICAL)
      - name: Create GitHub Release & upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_VERSION }}
          name: ${{ env.TAG_VERSION }}
          files: |
            publish/AxarDB-debian.zip
            publish/AxarDB-windows.zip
            publish/AxarDB-macos.zip
